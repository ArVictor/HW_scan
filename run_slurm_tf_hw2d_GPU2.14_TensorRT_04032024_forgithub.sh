#!/bin/bash -l
# Standard output and error:
#SBATCH -o ./out_tf_hw2d_train.%j
#SBATCH -e ./err_tf_hw2d_train.%j
# Initial working directory:
#SBATCH -D ./
# Job name
#SBATCH -J tf_hw2d_train
#
#SBATCH --ntasks=1
#SBATCH --constraint="gpu"
##SBATCH --partition=gpudev
#
# --- default case: use a single GPU on a shared node ---
#SBATCH --gres=gpu:a100:1
#SBATCH --cpus-per-task=18
#SBATCH --mem=125000
#
#SBATCH --time=1:35:00
##SBATCH --time=00:15:00

module purge
conda deactivate


module load anaconda/3/2023.03
module load tensorflow/gpu-cuda-12.1/2.14.0

module load keras/2.14.0

module load cupy/12.1

module load ffmpeg/4.4

conda activate conda3.10.9_tensorrt

python -V
module list
conda info --envs

echo $LD_LIBRARY_PATH

# Important:
# Set the number of OMP threads *per process* to avoid overloading of the node!
#export OMP_NUM_THREADS=1
export OMP_NUM_THREADS=${SLURM_CPUS_PER_TASK}

which python
nvidia-smi
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1','FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1']" --valid_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c5onlyeval1s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --layers=12 --filters=13 --lr=0.0 --decay_epochs=200 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=-1 --nu=0.0 --batch_norm=False --valid_batch=3 --valid_skips=20 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=5 --c1="{'train':[5.0,5.0,5.0],'valid':[1.0],'test':[1.0]}" --time_window_to_keep=500 --tensorrt_inference=True --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --load_model="c5HPS64_u8_lr0.00017_rho0.0907sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp99solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241121-230806_models/model_unrolled8_epoch_20midrun_951"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1','FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1']" --valid_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c5onlyeval02s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --layers=12 --filters=13 --lr=0.0 --decay_epochs=200 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=-4 --nu=0.0 --batch_norm=False --valid_batch=3 --valid_skips=20 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=5 --c1="{'train':[5.0,5.0,5.0],'valid':[0.2],'test':[0.2]}" --time_window_to_keep=500 --tensorrt_inference=True --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --load_model="c5HPS64_u8_lr0.00017_rho0.0907sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp99solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241121-230806_models/model_unrolled8_epoch_20midrun_951"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1','FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1']" --valid_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c1onlyeval02s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --layers=12 --filters=13 --lr=0.0 --decay_epochs=200 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=-1 --nu=0.0 --batch_norm=False --valid_batch=3 --valid_skips=20 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=5 --c1="{'train':[1.0,1.0,1.0],'valid':[0.2],'test':[0.2]}" --time_window_to_keep=500 --tensorrt_inference=True --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --load_model="NOGRADc1HPS64_u8_lr0.00033_rho0.07585sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp99solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241121-110747_models/model_unrolled8_epoch_20midrun_919"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1','FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1']" --valid_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c1onlyeval5s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --layers=12 --filters=13 --lr=0.0 --decay_epochs=200 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=-2 --nu=0.0 --batch_norm=False --valid_batch=3 --valid_skips=20 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=5 --c1="{'train':[1.0,1.0,1.0],'valid':[5.0],'test':[5.0]}" --time_window_to_keep=500 --tensorrt_inference=True --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --load_model="c1HPS64_u8_lr0.00231_rho0.09559sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp20solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20240508-050404_models/model_unrolled8_epoch_20midrun_903"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1','FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1']" --valid_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c02onlyeval5s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --layers=12 --filters=13 --lr=0.0 --decay_epochs=200 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=-2 --nu=0.0 --batch_norm=False --valid_batch=3 --valid_skips=20 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=5 --c1="{'train':[0.2,0.2,0.2],'valid':[5.0],'test':[5.0]}" --time_window_to_keep=500 --tensorrt_inference=True --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --load_model="c02HPS64_u8_lr0.00199_rho0.01988sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp99solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241122-083216_models/model_unrolled8_epoch_20midrun_999"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1','FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1']" --valid_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c02onlyeval1s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --layers=12 --filters=13 --lr=0.0 --decay_epochs=200 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=-4 --nu=0.0 --batch_norm=False --valid_batch=3 --valid_skips=20 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=5 --c1="{'train':[0.2,0.2,0.2],'valid':[1.0],'test':[1.0]}" --time_window_to_keep=500 --tensorrt_inference=True --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --load_model="c02HPS64_u8_lr0.00199_rho0.01988sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp99solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241122-083216_models/model_unrolled8_epoch_20midrun_999"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1']" --valid_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c502evaluate1s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --model_type="resnet" --layers=5 --filters=32 --lr=0.0 --optimizer_str="adamW" --rho=0.0 --SAM_warmup=0 --temporal_causality_eps=0.0 --decay_epochs=0 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=0 --nu=0.0 --batch_norm=True --valid_batch=3 --valid_skips=4 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=20 --c1="{'train':[0.2,5.0],'valid':[1.0],'test':[1.0]}" --time_window_to_keep=500 --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --tensorrt_inference=True  --load_model="c02HPS64_u8_lr0.00033_rho0.07585sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp20solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241122-175605_models/model_unrolled8_epoch_20midrun_935"
#srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1']" --valid_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c021evaluate5s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --model_type="resnet" --layers=5 --filters=32 --lr=0.0 --optimizer_str="adamW" --rho=0.0 --SAM_warmup=0 --temporal_causality_eps=0.0 --decay_epochs=0 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=0 --nu=0.0 --batch_norm=True --valid_batch=3 --valid_skips=4 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=20 --c1="{'train':[0.2,1.0],'valid':[5.0],'test':[5.0]}" --time_window_to_keep=500 --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --tensorrt_inference=True  --load_model="c021HPS64_u8_lr0.00033_rho0.07585sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp20solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241123-064241_models/model_unrolled8_epoch_20midrun_963"
srun python psil_hw2d_training_skeleton.py --train_dataset_path="['FFT_1000_512_c1_CPUnumba_dt01_nu5e-9_1_dataset_s64_t1','FFT_1800_512_c5_CPUnumba_dt01_nu5e-9_2_dataset_s64_t1']" --valid_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_4_dataset_s64_t1']" --test_dataset_path="['FFT_1000_512_c02_CPUnumba_dt01_nu5e-9_5_dataset_s64_t1']" --output_path="c15evaluate02s64_" --unrolled_steps=9 --solver_name="rk4" --poisson_method="fourier" --epochs_steps=1 --model_type="resnet" --layers=5 --filters=32 --lr=0.0 --optimizer_str="adamW" --rho=0.0 --SAM_warmup=0 --temporal_causality_eps=0.0 --decay_epochs=0 --batch_size_start=1 --batch_size_step=5 --batch_size_end=1 --weight_average=0 --nu=0.0 --batch_norm=True --valid_batch=3 --valid_skips=4 --steps_simulation=40000 --n_blocks_invariants=4 --early_stopping_patience=20 --c1="{'train':[1.0,5.0],'valid':[0.2],'test':[0.2]}" --time_window_to_keep=500 --evaluation_properties="['gamma_n_spectral','enstrophy','kinetic_energy','thermal_energy']" --tensorrt_inference=True  --load_model="c15HPS64_u8_lr0.00085_rho0.08012sw0tc0.0dec0bs20bt5be20epo1000sms1000vs4ve10vb1vw900sts20000l10WA0esp20solrk4_N3_nu0.0kap1.0ara1.0poisfouriertwtk500_snaps1buf100fps10_dpi75s5nb4f32_20241123-210752_models/model_unrolled8_epoch_20midrun_907"
